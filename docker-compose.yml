services:
  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: scoper_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Performance tuning for 8GB RAM server
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "1GB"
      POSTGRES_MAINTENANCE_WORK_MEM: "128MB"
      POSTGRES_MAX_CONNECTIONS: "100"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Expose port only on localhost (for SSH tunneling with TablePlus, DBeaver, etc.)
    # NOT accessible from internet - only via SSH tunnel
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - db_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================================
  # Backend - Flask + Gunicorn
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: scoper_backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      FLASK_ENV: production
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - caddy_network
      - db_network
    volumes:
      # Mount logs directory (optional, for persistent logs)
      - ./backend/logs:/app/logs
    command: bash -c "flask db upgrade && gunicorn -c gunicorn.conf.py app:app"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # Frontend - Next.js
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # This is baked into the build (NEXT_PUBLIC_* must be set at build time)
        NEXT_PUBLIC_API_URL: https://scoper.befreeclub.pro/api
    container_name: scoper_frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - caddy_network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  caddy_network:
    external: true
  db_network:
    driver: bridge
    internal: true

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data: