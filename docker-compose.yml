version: '3.9'

services:
  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: gigscope_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Performance tuning for 8GB RAM server
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "1GB"
      POSTGRES_MAINTENANCE_WORK_MEM: "128MB"
      POSTGRES_MAX_CONNECTIONS: "100"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - db_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================================
  # Backend - Flask + Gunicorn
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gigscope_backend
    restart: unless-stopped
    env_file:
      - .env.production
    environment:
      FLASK_ENV: production
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - web_network
      - db_network
    volumes:
      # Mount logs directory (optional, for persistent logs)
      - ./backend/logs:/app/logs
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # Frontend - Next.js
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gigscope_frontend
    restart: unless-stopped
    environment:
      # Next.js needs to know the backend API URL
      NEXT_PUBLIC_API_URL: https://gigscope.pl/api
      NODE_ENV: production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - web_network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # Caddy - Reverse Proxy + SSL
  # ============================================================================
  caddy:
    image: caddy:2-alpine
    container_name: gigscope_caddy
    restart: unless-stopped
    ports:
      - "80:80"    # HTTP
      - "443:443"  # HTTPS
      - "443:443/udp"  # HTTP/3 (QUIC)
    volumes:
      # Caddyfile configuration
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Persistent storage for SSL certificates
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - web_network
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============================================================================
# Networks
# ============================================================================
networks:
  # Web network - for Caddy <-> Frontend/Backend
  web_network:
    driver: bridge
    
  # Database network - for Backend <-> PostgreSQL only
  db_network:
    driver: bridge
    internal: true  # No external access to database

# ============================================================================
# Volumes
# ============================================================================
volumes:
  # PostgreSQL data - persistent database storage
  postgres_data:
    driver: local
    
  # Caddy data - SSL certificates and other persistent data
  caddy_data:
    driver: local
    
  # Caddy config - configuration cache
  caddy_config:
    driver: local

